import { FlatList, ScrollView, StyleSheet, Text, TouchableOpacity, View } from 'react-native';

import BackIcon from '@/assets/svg/BackIcon';
import Header from '@/components/Header';
import { useAuth } from '@/context/AuthContext';
import { router, useLocalSearchParams } from 'expo-router';
import React, { useEffect } from 'react';

import OrderItemCard from '@/components/cards/OrderItemCard';
import GradientButton from '@/components/ui/GradientButton';
import Svg, { Path, Rect } from "react-native-svg";
const PaymentButton = (props: any) => (
  <Svg
    width={"100%"}
    height={64}
    viewBox="0 0 400 64"
    fill="none"
    xmlns="http://www.w3.org/2000/svg"
    {...props}
  >
    <Rect width={400} height={64} rx={15} fill="#F8F8F8" />
    <Path
      d="M39.72 32.192C40.4773 32.3733 41.048 32.6987 41.432 33.168C41.8267 33.6267 42.024 34.2187 42.024 34.944C42.024 35.9147 41.6667 36.6667 40.952 37.2C40.248 37.7333 39.2187 38 37.864 38H32.744V26.8H37.56C38.7867 26.8 39.7413 27.0507 40.424 27.552C41.1173 28.0427 41.464 28.752 41.464 29.68C41.464 30.288 41.3093 30.8053 41 31.232C40.7013 31.6587 40.2747 31.9787 39.72 32.192ZM34.328 31.728H37.448C38.2267 31.728 38.8187 31.5733 39.224 31.264C39.64 30.9547 39.848 30.5013 39.848 29.904C39.848 29.3067 39.64 28.8533 39.224 28.544C38.808 28.224 38.216 28.064 37.448 28.064H34.328V31.728ZM37.832 36.736C39.5493 36.736 40.408 36.096 40.408 34.816C40.408 34.176 40.1893 33.7067 39.752 33.408C39.3253 33.0987 38.6853 32.944 37.832 32.944H34.328V36.736H37.832ZM44.4411 29.52H45.9771V35.696L51.1771 29.52H52.5691V38H51.0331V31.824L45.8491 38H44.4411V29.52ZM59.8705 29.808C60.6598 29.808 61.3638 29.984 61.9825 30.336C62.6012 30.688 63.0812 31.1787 63.4225 31.808C63.7745 32.4267 63.9505 33.136 63.9505 33.936C63.9505 34.7573 63.7638 35.488 63.3905 36.128C63.0278 36.7573 62.5105 37.248 61.8385 37.6C61.1772 37.952 60.4198 38.128 59.5665 38.128C58.1265 38.128 57.0118 37.6373 56.2225 36.656C55.4438 35.664 55.0545 34.272 55.0545 32.48C55.0545 30.7413 55.4118 29.3813 56.1265 28.4C56.8412 27.408 57.9345 26.752 59.4065 26.432L63.2785 25.568L63.5025 26.976L59.9345 27.744C58.8252 27.9893 57.9985 28.4053 57.4545 28.992C56.9105 29.5787 56.6012 30.4213 56.5265 31.52C56.8892 30.976 57.3585 30.5547 57.9345 30.256C58.5105 29.9573 59.1558 29.808 59.8705 29.808ZM59.5985 36.848C60.1425 36.848 60.6225 36.7253 61.0385 36.48C61.4652 36.2347 61.7958 35.8987 62.0305 35.472C62.2652 35.0347 62.3825 34.5387 62.3825 33.984C62.3825 33.1413 62.1265 32.464 61.6145 31.952C61.1025 31.44 60.4305 31.184 59.5985 31.184C58.7665 31.184 58.0892 31.44 57.5665 31.952C57.0545 32.464 56.7985 33.1413 56.7985 33.984C56.7985 34.5387 56.9158 35.0347 57.1505 35.472C57.3958 35.8987 57.7318 36.2347 58.1585 36.48C58.5852 36.7253 59.0652 36.848 59.5985 36.848ZM73.8083 33.808C73.8083 33.9253 73.7976 34.08 73.7763 34.272H66.8963C66.9923 35.0187 67.3176 35.6213 67.8723 36.08C68.4376 36.528 69.1363 36.752 69.9683 36.752C70.9816 36.752 71.7976 36.4107 72.4163 35.728L73.2643 36.72C72.8803 37.168 72.4003 37.5093 71.8243 37.744C71.2589 37.9787 70.6243 38.096 69.9203 38.096C69.0243 38.096 68.2296 37.9147 67.5363 37.552C66.8429 37.1787 66.3043 36.6613 65.9203 36C65.5469 35.3387 65.3603 34.592 65.3603 33.76C65.3603 32.9387 65.5416 32.1973 65.9043 31.536C66.2776 30.8747 66.7843 30.3627 67.4243 30C68.0749 29.6267 68.8056 29.44 69.6163 29.44C70.4269 29.44 71.1469 29.6267 71.7763 30C72.4163 30.3627 72.9123 30.8747 73.2643 31.536C73.6269 32.1973 73.8083 32.9547 73.8083 33.808ZM69.6163 30.736C68.8803 30.736 68.2616 30.96 67.7603 31.408C67.2696 31.856 66.9816 32.4427 66.8963 33.168H72.3363C72.2509 32.4533 71.9576 31.872 71.4563 31.424C70.9656 30.9653 70.3523 30.736 69.6163 30.736ZM80.6871 29.44C81.5085 29.44 82.2445 29.6213 82.8951 29.984C83.5458 30.3467 84.0525 30.8533 84.4151 31.504C84.7885 32.1547 84.9751 32.9067 84.9751 33.76C84.9751 34.6133 84.7885 35.3707 84.4151 36.032C84.0525 36.6827 83.5458 37.1893 82.8951 37.552C82.2445 37.9147 81.5085 38.096 80.6871 38.096C80.0791 38.096 79.5191 37.9787 79.0071 37.744C78.5058 37.5093 78.0791 37.168 77.7271 36.72V41.104H76.1911V29.52H77.6631V30.864C78.0045 30.3947 78.4365 30.0427 78.9591 29.808C79.4818 29.5627 80.0578 29.44 80.6871 29.44ZM80.5591 36.752C81.1031 36.752 81.5885 36.6293 82.0151 36.384C82.4525 36.128 82.7938 35.776 83.0391 35.328C83.2951 34.8693 83.4231 34.3467 83.4231 33.76C83.4231 33.1733 83.2951 32.656 83.0391 32.208C82.7938 31.7493 82.4525 31.3973 82.0151 31.152C81.5885 30.9067 81.1031 30.784 80.5591 30.784C80.0258 30.784 79.5405 30.912 79.1031 31.168C78.6765 31.4133 78.3351 31.76 78.0791 32.208C77.8338 32.656 77.7111 33.1733 77.7111 33.76C77.7111 34.3467 77.8338 34.8693 78.0791 35.328C78.3245 35.776 78.6658 36.128 79.1031 36.384C79.5405 36.6293 80.0258 36.752 80.5591 36.752ZM87.2068 29.52H88.7428V38H87.2068V29.52ZM87.9748 27.888C87.6761 27.888 87.4254 27.792 87.2228 27.6C87.0308 27.408 86.9348 27.1733 86.9348 26.896C86.9348 26.6187 87.0308 26.384 87.2228 26.192C87.4254 25.9893 87.6761 25.888 87.9748 25.888C88.2734 25.888 88.5188 25.984 88.7108 26.176C88.9134 26.3573 89.0148 26.5867 89.0148 26.864C89.0148 27.152 88.9134 27.3973 88.7108 27.6C88.5188 27.792 88.2734 27.888 87.9748 27.888ZM98.058 30.864H94.954V38H93.418V30.864H90.314V29.52H98.058V30.864ZM103.549 32.4C104.626 32.4107 105.447 32.656 106.013 33.136C106.578 33.616 106.861 34.2933 106.861 35.168C106.861 36.0853 106.551 36.7947 105.933 37.296C105.325 37.7867 104.45 38.0267 103.309 38.016L99.6286 38V29.52H101.165V32.384L103.549 32.4ZM103.181 36.848C103.874 36.8587 104.397 36.72 104.749 36.432C105.111 36.144 105.293 35.7173 105.293 35.152C105.293 34.5973 105.117 34.192 104.765 33.936C104.423 33.68 103.895 33.5467 103.181 33.536L101.165 33.504V36.832L103.181 36.848ZM116.825 38.096C115.961 38.096 115.187 37.9093 114.505 37.536C113.833 37.1627 113.305 36.6507 112.921 36C112.537 35.3387 112.345 34.592 112.345 33.76C112.345 32.928 112.537 32.1867 112.921 31.536C113.305 30.8747 113.833 30.3627 114.505 30C115.187 29.6267 115.961 29.44 116.825 29.44C117.593 29.44 118.275 29.5947 118.873 29.904C119.481 30.2133 119.95 30.6613 120.281 31.248L119.113 32C118.846 31.5947 118.515 31.2907 118.121 31.088C117.726 30.8853 117.289 30.784 116.809 30.784C116.254 30.784 115.753 30.9067 115.305 31.152C114.867 31.3973 114.521 31.7493 114.265 32.208C114.019 32.656 113.897 33.1733 113.897 33.76C113.897 34.3573 114.019 34.8853 114.265 35.344C114.521 35.792 114.867 36.1387 115.305 36.384C115.753 36.6293 116.254 36.752 116.809 36.752C117.289 36.752 117.726 36.6507 118.121 36.448C118.515 36.2453 118.846 35.9413 119.113 35.536L120.281 36.272C119.95 36.8587 119.481 37.312 118.873 37.632C118.275 37.9413 117.593 38.096 116.825 38.096ZM130.125 29.52V38H128.589V30.864H123.805V38H122.269V29.52H130.125ZM136.729 38.096C135.887 38.096 135.129 37.9093 134.457 37.536C133.785 37.1627 133.257 36.6507 132.873 36C132.5 35.3387 132.313 34.592 132.313 33.76C132.313 32.928 132.5 32.1867 132.873 31.536C133.257 30.8747 133.785 30.3627 134.457 30C135.129 29.6267 135.887 29.44 136.729 29.44C137.572 29.44 138.324 29.6267 138.985 30C139.657 30.3627 140.18 30.8747 140.553 31.536C140.937 32.1867 141.129 32.928 141.129 33.76C141.129 34.592 140.937 35.3387 140.553 36C140.18 36.6507 139.657 37.1627 138.985 37.536C138.324 37.9093 137.572 38.096 136.729 38.096ZM136.729 36.752C137.273 36.752 137.759 36.6293 138.185 36.384C138.623 36.128 138.964 35.776 139.209 35.328C139.455 34.8693 139.577 34.3467 139.577 33.76C139.577 33.1733 139.455 32.656 139.209 32.208C138.964 31.7493 138.623 31.3973 138.185 31.152C137.759 30.9067 137.273 30.784 136.729 30.784C136.185 30.784 135.695 30.9067 135.257 31.152C134.831 31.3973 134.489 31.7493 134.233 32.208C133.988 32.656 133.865 33.1733 133.865 33.76C133.865 34.3467 133.988 34.8693 134.233 35.328C134.489 35.776 134.831 36.128 135.257 36.384C135.695 36.6293 136.185 36.752 136.729 36.752ZM147.043 38.096C146.179 38.096 145.406 37.9093 144.723 37.536C144.051 37.1627 143.523 36.6507 143.139 36C142.755 35.3387 142.563 34.592 142.563 33.76C142.563 32.928 142.755 32.1867 143.139 31.536C143.523 30.8747 144.051 30.3627 144.723 30C145.406 29.6267 146.179 29.44 147.043 29.44C147.811 29.44 148.494 29.5947 149.091 29.904C149.699 30.2133 150.169 30.6613 150.499 31.248L149.331 32C149.065 31.5947 148.734 31.2907 148.339 31.088C147.945 30.8853 147.507 30.784 147.027 30.784C146.473 30.784 145.971 30.9067 145.523 31.152C145.086 31.3973 144.739 31.7493 144.483 32.208C144.238 32.656 144.115 33.1733 144.115 33.76C144.115 34.3573 144.238 34.8853 144.483 35.344C144.739 35.792 145.086 36.1387 145.523 36.384C145.971 36.6293 146.473 36.752 147.027 36.752C147.507 36.752 147.945 36.6507 148.339 36.448C148.734 36.2453 149.065 35.9413 149.331 35.536L150.499 36.272C150.169 36.8587 149.699 37.312 149.091 37.632C148.494 37.9413 147.811 38.096 147.043 38.096ZM152.488 29.52H154.024V38H152.488V29.52ZM153.256 27.888C152.957 27.888 152.707 27.792 152.504 27.6C152.312 27.408 152.216 27.1733 152.216 26.896C152.216 26.6187 152.312 26.384 152.504 26.192C152.707 25.9893 152.957 25.888 153.256 25.888C153.555 25.888 153.8 25.984 153.992 26.176C154.195 26.3573 154.296 26.5867 154.296 26.864C154.296 27.152 154.195 27.3973 153.992 27.6C153.8 27.792 153.555 27.888 153.256 27.888ZM161.339 29.808C162.129 29.808 162.833 29.984 163.451 30.336C164.07 30.688 164.55 31.1787 164.891 31.808C165.243 32.4267 165.419 33.136 165.419 33.936C165.419 34.7573 165.233 35.488 164.859 36.128C164.497 36.7573 163.979 37.248 163.307 37.6C162.646 37.952 161.889 38.128 161.035 38.128C159.595 38.128 158.481 37.6373 157.691 36.656C156.913 35.664 156.523 34.272 156.523 32.48C156.523 30.7413 156.881 29.3813 157.595 28.4C158.31 27.408 159.403 26.752 160.875 26.432L164.747 25.568L164.971 26.976L161.403 27.744C160.294 27.9893 159.467 28.4053 158.923 28.992C158.379 29.5787 158.07 30.4213 157.995 31.52C158.358 30.976 158.827 30.5547 159.403 30.256C159.979 29.9573 160.625 29.808 161.339 29.808ZM161.067 36.848C161.611 36.848 162.091 36.7253 162.507 36.48C162.934 36.2347 163.265 35.8987 163.499 35.472C163.734 35.0347 163.851 34.5387 163.851 33.984C163.851 33.1413 163.595 32.464 163.083 31.952C162.571 31.44 161.899 31.184 161.067 31.184C160.235 31.184 159.558 31.44 159.035 31.952C158.523 32.464 158.267 33.1413 158.267 33.984C158.267 34.5387 158.385 35.0347 158.619 35.472C158.865 35.8987 159.201 36.2347 159.627 36.48C160.054 36.7253 160.534 36.848 161.067 36.848ZM175.542 38.096C174.699 38.096 173.942 37.9093 173.27 37.536C172.598 37.1627 172.07 36.6507 171.686 36C171.313 35.3387 171.126 34.592 171.126 33.76C171.126 32.928 171.313 32.1867 171.686 31.536C172.07 30.8747 172.598 30.3627 173.27 30C173.942 29.6267 174.699 29.44 175.542 29.44C176.385 29.44 177.137 29.6267 177.798 30C178.47 30.3627 178.993 30.8747 179.366 31.536C179.75 32.1867 179.942 32.928 179.942 33.76C179.942 34.592 179.75 35.3387 179.366 36C178.993 36.6507 178.47 37.1627 177.798 37.536C177.137 37.9093 176.385 38.096 175.542 38.096ZM175.542 36.752C176.086 36.752 176.571 36.6293 176.998 36.384C177.435 36.128 177.777 35.776 178.022 35.328C178.267 34.8693 178.39 34.3467 178.39 33.76C178.39 33.1733 178.267 32.656 178.022 32.208C177.777 31.7493 177.435 31.3973 176.998 31.152C176.571 30.9067 176.086 30.784 175.542 30.784C174.998 30.784 174.507 30.9067 174.07 31.152C173.643 31.3973 173.302 31.7493 173.046 32.208C172.801 32.656 172.678 33.1733 172.678 33.76C172.678 34.3467 172.801 34.8693 173.046 35.328C173.302 35.776 173.643 36.128 174.07 36.384C174.507 36.6293 174.998 36.752 175.542 36.752ZM190.016 29.52V38H188.48V30.864H183.696V38H182.16V29.52H190.016ZM200.268 29.52V38H198.732V30.864H195.084L194.988 32.752C194.935 33.8933 194.833 34.848 194.684 35.616C194.535 36.3733 194.289 36.9813 193.948 37.44C193.607 37.8987 193.132 38.128 192.524 38.128C192.247 38.128 191.932 38.08 191.58 37.984L191.676 36.688C191.815 36.72 191.943 36.736 192.06 36.736C192.487 36.736 192.807 36.5493 193.02 36.176C193.233 35.8027 193.372 35.36 193.436 34.848C193.5 34.336 193.559 33.6053 193.612 32.656L193.756 29.52H200.268ZM206.262 29.44C207.435 29.44 208.331 29.728 208.95 30.304C209.579 30.88 209.894 31.7387 209.894 32.88V38H208.438V36.88C208.182 37.2747 207.814 37.5787 207.334 37.792C206.865 37.9947 206.305 38.096 205.654 38.096C204.705 38.096 203.942 37.8667 203.366 37.408C202.801 36.9493 202.518 36.3467 202.518 35.6C202.518 34.8533 202.79 34.256 203.334 33.808C203.878 33.3493 204.742 33.12 205.926 33.12H208.358V32.816C208.358 32.1547 208.166 31.648 207.782 31.296C207.398 30.944 206.833 30.768 206.086 30.768C205.585 30.768 205.094 30.8533 204.614 31.024C204.134 31.184 203.729 31.4027 203.398 31.68L202.758 30.528C203.195 30.176 203.718 29.9093 204.326 29.728C204.934 29.536 205.579 29.44 206.262 29.44ZM205.91 36.912C206.497 36.912 207.003 36.784 207.43 36.528C207.857 36.2613 208.166 35.888 208.358 35.408V34.224H205.99C204.689 34.224 204.038 34.6613 204.038 35.536C204.038 35.9627 204.203 36.2987 204.534 36.544C204.865 36.7893 205.323 36.912 205.91 36.912ZM218.98 30.864H215.876V38H214.34V30.864H211.236V29.52H218.98V30.864ZM220.551 29.52H222.087V35.696L227.286 29.52H228.679V38H227.142V31.824L221.959 38H220.551V29.52Z"
      fill="#7D7D7D"
    />
    <Path
      d="M371.607 22.0551C371.024 21.4724 370.08 21.4724 369.497 22.0551C368.914 22.6378 368.914 23.5826 369.497 24.1654L376.883 31.552L369.497 38.9386C368.914 39.5214 368.914 40.4662 369.497 41.0489C370.08 41.6316 371.024 41.6316 371.607 41.0489L380.049 32.6071C380.632 32.0244 380.632 31.0796 380.049 30.4969L371.607 22.0551Z"
      fill="black"
    />
  </Svg>
);


export default function CartScreen() {
  const { user } = useAuth();
  const [loading, setLoading] = React.useState(false);
  const [error, setError] = React.useState('');
  const [cart, setCart] = React.useState<any[]>([]);
  const [order, setOrder] = React.useState<any>(null);
  const {data} = useLocalSearchParams();
  const parsedData = JSON.parse(data as string);

  const fetchOrder = async () => {
    const res = await fetch(`${process.env.EXPO_PUBLIC_API_URL}/orders/${parsedData.orderId}`);
    const data = await res.json();
    console.log(data);
    setOrder(data);
  };

  const handleTakeOrder = async () => {
    try {
      setLoading(true);
      setError('');
      const res = await fetch(
        `${process.env.EXPO_PUBLIC_API_URL}/orders/${order._id}/take`,
        {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            // Добавьте авторизацію, якщо потрібно:
            // Authorization: `Bearer ${user.token}`,
          },
          body: JSON.stringify({ courierId: user?._id }),
        }
      );
      if (!res.ok) {
        const errData = await res.json();
        setError(errData.message || 'Не вдалося прийняти замовлення');
        setLoading(false);
        return;
      }
      const updatedOrder = await res.json();
      setOrder(updatedOrder);
      router.push("/orderStatus");
    } catch (err) {
      setError('Сталася помилка');
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchOrder();
  }, []);

  if (!order) return <Text>Завантаження...</Text>;
  
  return (
     <View style={{backgroundColor: "white", flex: 1}}>
        <Header
            title="Ваше замовлення"
            titleStyle={{
                fontWeight: 700,}}
            leftContent={<BackIcon />}
            onLeftPress={() => router.back()}
        />
      <ScrollView style={{paddingTop: 100, paddingHorizontal: 20}}>
            
            <Text style={{marginVertical: 30, fontWeight: 700, fontSize: 20}}>Товар ({order.items.length})</Text>
            <FlatList
              data={order.items}
              keyExtractor={(item, idx) => item.id?.toString() || idx.toString()}
              contentContainerStyle={{gap: 10}}
              renderItem={({ item }) => (
                <OrderItemCard
                    key={item._id}
                    _id={item._id}
                    name={item.pharmacyProduct?.product.name}
                    price={item.pharmacyProduct?.price}
                    image={item.pharmacyProduct?.product.image}
                  />
              )}
            />
            <Text style={{marginVertical: 30, fontWeight: 700, fontSize: 20}}>Спосіб оплати</Text>

            <TouchableOpacity
              onPress={() => router.push('/')}>
                <PaymentButton/>
              </TouchableOpacity>
            <Text style={{marginVertical: 30, fontWeight: 700, fontSize: 20}}>Зведена інформація</Text>
            <View style={{gap: 23, marginBottom: 400}}>
                <View style={{
                    flexDirection: 'row',
                    justifyContent: 'space-between',
                    alignItems: 'center',
                    gap: 7
                }}>
                    <Text style={{
                        fontSize: 16,
                        fontWeight: 500,
                    }}>Товари</Text>
                    <View style={{flex: 1, borderTopWidth: 1, borderColor: "#404040"}}/>
                    <Text style={{
                        color: "#158EFF",
                        fontSize: 16,
                        fontWeight: 700,
                    }}>499₴</Text>
                </View>
                <View style={{
                    flexDirection: 'row',
                    justifyContent: 'space-between',
                    alignItems: 'center',
                    gap: 7
                }}>
                    <Text style={{
                        fontSize: 16,
                        fontWeight: 500,
                    }}>Доставка</Text>
                    <View style={{flex: 1, borderTopWidth: 1, borderColor: "#404040"}}/>
                    <Text style={{
                        color: "#158EFF",
                        fontSize: 16,
                        fontWeight: 700,
                    }}>34,99₴</Text>
                </View>
                <View style={{
                    flexDirection: 'row',
                    justifyContent: 'space-between',
                    alignItems: 'center',
                    gap: 7
                }}>
                    <Text style={{
                        fontSize: 16,
                        fontWeight: 500,
                    }}>Сервісний збір</Text>
                    <View style={{flex: 1, borderTopWidth: 1, borderColor: "#404040"}}/>
                    <Text style={{
                        color: "#158EFF",
                        fontSize: 16,
                        fontWeight: 700,
                    }}>14,99₴</Text>
                </View>
                <View style={{
                    flexDirection: 'row',
                    justifyContent: 'space-between',
                    alignItems: 'center',
                    gap: 7
                }}>
                    <Text style={{
                        fontSize: 16,
                        fontWeight: 500,
                    }}>Усього</Text>
                    <View style={{flex: 1, borderTopWidth: 1, borderColor: "#404040"}}/>
                    <Text style={{
                        color: "#158EFF",
                        fontSize: 16,
                        fontWeight: 700,
                    }}>548,98₴</Text>
                </View>

            </View>
      </ScrollView>
       <GradientButton
         title={loading ? "Приймаємо..." : "Прийняти запит"}
         style={{width: "95%", position: "absolute", alignSelf: "center", bottom: 50}}
         onPress={handleTakeOrder}
         disabled={loading}
       />
    </View>
  );
}

const styles = StyleSheet.create({
  headerImage: {
    color: '#808080',
    bottom: -90,
    left: -35,
    position: 'absolute',
  },
  titleContainer: {
    flexDirection: 'row',
    gap: 8,
  },
});
